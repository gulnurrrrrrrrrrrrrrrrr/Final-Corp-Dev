<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>QuadLingo ‚Äî “ö–∞–∑–∞“õ —Ç—ñ–ª—ñ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üöÄ QuadLingo ‚Äî “ö–∞–∑–∞“õ—à–∞ “Ø–π—Ä–µ–Ω!</h1>
        <nav id="nav" style="display:none">
            <a href="index.html">–ë–∞—Å—Ç—ã –±–µ—Ç</a>
            <a href="profile.html">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="admin.html" id="adminLink" style="display:none">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
            <button onclick="logout()">–®—ã“ì—É</button>
        </nav>
    </header>

    <div class="container">
        <div id="auth" class="card" style="max-width:500px; margin:50px auto">
            <h2 style="color:#333; text-align:center">–ö—ñ—Ä—É / –¢—ñ—Ä–∫–µ—É</h2>
            <input id="username" placeholder="–õ–æ–≥–∏–Ω (–º—ã—Å–∞–ª—ã: admin)" value="admin">
            <input id="email" placeholder="Email (—Ç—ñ—Ä–∫–µ—É “Ø—à—ñ–Ω)" value="admin@quadlingo.kz">
            <input id="password" type="password" placeholder="“ö“±–ø–∏—è —Å”©–∑" value="admin2025">
            <div style="text-align:center">
                <button onclick="login()">–ö—ñ—Ä—É</button>
                <button class="manager" onclick="register()">–¢—ñ—Ä–∫–µ—É</button>
            </div>
            <p id="authMsg" style="color:red; text-align:center; margin-top:15px"></p>
        </div>

        <div id="main" style="display:none">
            <h2 style="color:white; text-align:center">–°”ô–ª–µ–º, <span id="userName"></span>! (<span id="userRole"></span>)</h2>
            <h2 style="color:white">–°–∞–±–∞“õ—Ç–∞—Ä</h2>
            <div id="lessons" class="cards"></div>
            <p id="noLessons" style="color:white; text-align:center; display:none">”ò–∑—ñ—Ä–≥–µ —Å–∞–±–∞“õ—Ç–∞—Ä –∂–æ“õ. –ê–¥–º–∏–Ω –Ω–µ–º–µ—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä “õ–æ—Å—Å—ã–Ω!</p>
        </div>
    </div>

    <script>
        const API = 'http://localhost:8080';
        let token = localStorage.getItem('token');

        if (token) {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('main').style.display = 'block';
            document.getElementById('nav').style.display = 'block';
            loadProfile();
            loadLessons();
        }

        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            await auth('/login', {username, password});
        }

        async function register() {
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            await auth('/register', {username, email, password});
        }

        async function auth(endpoint, body) {
            const msg = document.getElementById('authMsg');
            try {
                const res = await fetch(API + endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('token', data.token);
                    location.reload();
                } else {
                    msg.textContent = '“ö–∞—Ç–µ –ª–æ–≥–∏–Ω –Ω–µ–º–µ—Å–µ –ø–∞—Ä–æ–ª—å';
                }
            } catch (err) {
                msg.textContent = '–°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª—É “õ–∞—Ç–µ—Å—ñ';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        async function loadProfile() {
            try {
                const res = await fetch(API + '/api/profile', {
                    headers: {Authorization: `Bearer ${token}`}
                });
                const data = await res.json();
                document.getElementById('userName').textContent = data.user.username;
                document.getElementById('userRole').textContent = data.user.role;
                if (data.user.role === 'admin') {
                    document.getElementById('adminLink').style.display = 'inline';
                }
            } catch (err) {
                logout();
            }
        }

        async function loadLessons() {
            const res = await fetch(API + '/lessons');
            const lessons = await res.json();
            const container = document.getElementById('lessons');
            const noLessons = document.getElementById('noLessons');
            if (lessons.length === 0) {
                noLessons.style.display = 'block';
                container.innerHTML = '';
                return;
            }
            noLessons.style.display = 'none';
            container.innerHTML = lessons.map(l => `
                <div class="card">
                    <h3>${l.title}</h3>
                    <p>${l.description || ''}</p>
                    <small>–†–µ—Ç: ${l.order}</small>
                    <br><br>
                    <button onclick="window.location.href='lesson.html?id=${l.id}'">–°–∞–±–∞“õ—Ç—ã –∞—à—É</button>
                </div>
            `).join('');
        }
    </script>
</body>
</html>