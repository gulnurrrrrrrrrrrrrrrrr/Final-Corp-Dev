<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–Ω–µ–ª—ñ ‚Äî QuadLingo</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–Ω–µ–ª—ñ</h1>
        <nav>
            <a href="index.html">‚Üê –ë–∞—Å—Ç—ã –±–µ—Ç</a>
            <a href="profile.html">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <button onclick="logout()">–®—ã“ì—É</button>
        </nav>
    </header>

    <div class="container">
        <div class="card">
            <h2 style="color:#333; text-align:center">–°–∞–±–∞“õ—Ç–∞—Ä–¥—ã –±–∞—Å“õ–∞—Ä—É</h2>

            <div style="text-align:center; margin:30px 0">
                <button class="manager" onclick="showAddLessonForm()">–ñ–∞“£–∞ —Å–∞–±–∞“õ “õ–æ—Å—É</button>
            </div>

            <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É—Ä–æ–∫–∞ -->
            <div id="addLessonForm" style="display:none; background:#f8f9fa; padding:25px; border-radius:12px; margin:20px 0">
                <h3 style="color:#333; margin-bottom:20px">–ñ–∞“£–∞ —Å–∞–±–∞“õ “õ–æ—Å—É</h3>
                <input id="lessonTitle" placeholder="–°–∞–±–∞“õ –∞—Ç–∞—É—ã (–º—ñ–Ω–¥–µ—Ç—Ç—ñ)" required style="margin-bottom:10px">
                <input id="lessonDesc" placeholder="“ö—ã—Å“õ–∞—à–∞ —Å–∏–ø–∞—Ç—Ç–∞–º–∞ (“õ–æ—Å—ã–º—à–∞)">
                <textarea id="lessonContent" placeholder="–°–∞–±–∞“õ –º–∞–∑–º“±–Ω—ã (—Ç–æ–ª—ã“õ –º”ô—Ç—ñ–Ω, –º—ñ–Ω–¥–µ—Ç—Ç—ñ)" rows="12" required style="width:100%; padding:12px; margin:10px 0; border-radius:8px; border:1px solid #ccc"></textarea>
                <input id="lessonOrder" type="number" placeholder="–†–µ—Ç –Ω”©–º—ñ—Ä—ñ (–º—ã—Å–∞–ª—ã: 1)" value="1" style="margin-top:10px">
                
                <div style="text-align:center; margin-top:20px">
                    <button class="manager" onclick="createLesson()">–°–∞–±–∞“õ—Ç—ã —Å–∞“õ—Ç–∞—É</button>
                    <button onclick="hideAddLessonForm()" style="background:#95a5a6; margin-left:10px">–ë–∞—Å —Ç–∞—Ä—Ç—É</button>
                </div>
                <p id="lessonMsg" style="text-align:center; margin-top:15px; font-weight:bold"></p>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤ -->
            <h3 style="color:#333; margin-top:40px">“ö–æ—Å—ã–ª“ì–∞–Ω —Å–∞–±–∞“õ—Ç–∞—Ä</h3>
            <div id="lessonsList" class="cards"></div>
            <p id="noLessons" style="text-align:center; color:#666; font-style:italic; display:none">
                ”ò–∑—ñ—Ä–≥–µ —Å–∞–±–∞“õ—Ç–∞—Ä –∂–æ“õ. –ñ–æ“ì–∞—Ä—ã–¥–∞“ì—ã –∫–Ω–æ–ø–∫–∞–º–µ–Ω –∂–∞“£–∞—Å—ã–Ω “õ–æ—Å—ã“£—ã–∑!
            </p>
        </div>
    </div>

    <script>
        const API = 'http://localhost:8080';
        let token = localStorage.getItem('token');

        if (!token) {
            alert('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è “õ–∞–∂–µ—Ç!');
            window.location.href = 'index.html';
        }

        fetch(API + '/api/profile', {
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(res => res.json())
        .then(data => {
            if (data.user.role !== 'manager') {
                alert('–†“±“õ—Å–∞—Ç –∂–æ“õ! –ë“±–ª –±–µ—Ç —Ç–µ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–ª–µ—Ä–≥–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω.');
                window.location.href = 'index.html';
            }
            loadMyLessons();
        })
        .catch(() => {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        });

        async function loadMyLessons() {
            try {
                const res = await fetch(API + '/lessons', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const lessons = await res.json();

                const container = document.getElementById('lessonsList');
                const noLessons = document.getElementById('noLessons');

                if (lessons.length === 0) {
                    noLessons.style.display = 'block';
                    container.innerHTML = '';
                    return;
                }

                noLessons.style.display = 'none';
                container.innerHTML = lessons.map(l => `
                    <div class="card">
                        <h3>${l.title}</h3>
                        <p><strong>–°–∏–ø–∞—Ç—Ç–∞–º–∞:</strong> ${l.description || '–ñ–æ“õ'}</p>
                        <p><strong>–†–µ—Ç:</strong> ${l.order}</p>
                        <p><strong>“ö–æ—Å—ã–ª“ì–∞–Ω:</strong> ${new Date(l.created_at).toLocaleDateString('kk-KZ')}</p>
                        <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin-top:15px; line-height:1.8">
                            ${l.content.replace(/\n/g, '<br>')}
                        </div>
                        <button class="manager" onclick="showTestForm(${l.id}, '${l.title.replace(/'/g, "\\'")}')" style="margin-top:15px">
                            –ñ–∞“£–∞ —Ç–µ—Å—Ç “õ–æ—Å—É
                        </button>
                    </div>
                `).join('');
            } catch (err) {
                alert('–°–∞–±–∞“õ—Ç–∞—Ä–¥—ã –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ');
                console.error(err);
            }
        }

        function showTestForm(lessonId, lessonTitle) {
            const questionsCount = prompt(`"${lessonTitle}" —Å–∞–±–∞“ì—ã–Ω–∞ –Ω–µ—à–µ —Å“±—Ä–∞“õ “õ–æ—Å–∞—Å—ã–∑? (–º—ã—Å–∞–ª—ã: 5)`, '5');
            if (!questionsCount || isNaN(questionsCount) || questionsCount < 1) return;

            let formHTML = `
                <div id="testForm-${lessonId}" style="background:#e8f5e8; padding:25px; border-radius:12px; margin:30px 0; border:2px solid #27ae60">
                    <h3 style="color:#27ae60; text-align:center">–¢–µ—Å—Ç “õ–æ—Å—É: "${lessonTitle}"</h3>
                    <p style="text-align:center">–°“±—Ä–∞“õ—Ç–∞—Ä —Å–∞–Ω—ã: ${questionsCount}</p>
            `;

            for (let i = 1; i <= questionsCount; i++) {
                formHTML += `
                    <div class="question" style="background:white; padding:20px; margin:15px 0; border-radius:10px; border:1px solid #ccc">
                        <p><strong>${i}. –°“±—Ä–∞“õ –º”ô—Ç—ñ–Ω—ñ:</strong></p>
                        <input type="text" id="q${lessonId}_${i}_text" placeholder="–°“±—Ä–∞“õ (–º—ã—Å–∞–ª—ã: –°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ –¥–µ–≥–µ–Ω –Ω–µ?)" style="width:100%; margin-bottom:10px">
                        
                        <p><strong>–í–∞—Ä–∏–∞–Ω—Ç—Ç–∞—Ä:</strong></p>
                        <input type="text" id="q${lessonId}_${i}_opt1" placeholder="1-–≤–∞—Ä–∏–∞–Ω—Ç" style="margin-bottom:5px">
                        <input type="text" id="q${lessonId}_${i}_opt2" placeholder="2-–≤–∞—Ä–∏–∞–Ω—Ç" style="margin-bottom:5px">
                        <input type="text" id="q${lessonId}_${i}_opt3" placeholder="3-–≤–∞—Ä–∏–∞–Ω—Ç" style="margin-bottom:5px">
                        <input type="text" id="q${lessonId}_${i}_opt4" placeholder="4-–≤–∞—Ä–∏–∞–Ω—Ç" style="margin-bottom:10px">
                        
                        <p><strong>–î“±—Ä—ã—Å –∂–∞—É–∞–ø –Ω”©–º—ñ—Ä—ñ:</strong></p>
                        <select id="q${lessonId}_${i}_correct">
                            <option value="0">1</option>
                            <option value="1">2</option>
                            <option value="2">3</option>
                            <option value="3">4</option>
                        </select>
                    </div>
                `;
            }

            formHTML += `
                <div style="text-align:center; margin-top:20px">
                    <button class="manager" onclick="submitTest(${lessonId}, ${questionsCount})">–¢–µ—Å—Ç—Ç—ñ —Å–∞“õ—Ç–∞—É</button>
                    <button onclick="document.getElementById('testForm-${lessonId}').remove()" style="background:#e74c3c; margin-left:10px">–ë–∞—Å —Ç–∞—Ä—Ç—É</button>
                </div>
                <p id="testMsg-${lessonId}" style="text-align:center; margin-top:15px; font-weight:bold"></p>
            </div>
            `;

            // –í—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —É—Ä–æ–∫–∞
            const lessonCard = document.querySelector(`#lessonsList .card:last-child`);
            if (lessonCard) {
                lessonCard.insertAdjacentHTML('afterend', formHTML);
            } else {
                document.getElementById('lessonsList').insertAdjacentHTML('beforeend', formHTML);
            }
        }

        async function submitTest(lessonId, questionsCount) {
    const questions = [];

    for (let i = 1; i <= questionsCount; i++) {
        const text = document.getElementById(`q${lessonId}_${i}_text`).value.trim();
        const opts = [
            document.getElementById(`q${lessonId}_${i}_opt1`).value.trim(),
            document.getElementById(`q${lessonId}_${i}_opt2`).value.trim(),
            document.getElementById(`q${lessonId}_${i}_opt3`).value.trim(),
            document.getElementById(`q${lessonId}_${i}_opt4`).value.trim()
        ];
        const correct = parseInt(document.getElementById(`q${lessonId}_${i}_correct`).value);

        if (!text || opts.some(o => o === '')) {
            alert(`–ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑! –°“±—Ä–∞“õ ${i}`);
            return;
        }

        questions.push({
            question_text: text,
            options: opts,
            correct_answer: correct
        });
    }

    try {
        const res = await fetch(API + '/api/tests', {  // ‚Üê –û–°–´ –ñ–ï–†–î–Ü ”®–ó–ì–ï–†–¢–¢–Ü–ö!
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                lesson_id: lessonId,
                questions: questions
            })
        });

        const msg = document.getElementById(`testMsg-${lessonId}`);
        if (res.ok) {
            const result = await res.json();
            msg.textContent = '–¢–µ—Å—Ç —Å”ô—Ç—Ç—ñ “õ–æ—Å—ã–ª–¥—ã! üéâ';
            msg.style.color = 'green';
            loadMyLessons(); // –ñ–∞“£–∞—Ä—Ç—É
        } else {
            const error = await res.text();
            msg.textContent = '“ö–∞—Ç–µ: ' + error;
            msg.style.color = 'red';
        }
    } catch (err) {
        alert('–°–µ—Ä–≤–µ—Ä–º–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å “õ–∞—Ç–µ—Å—ñ');
        console.error(err);
    }
}

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (showAddLessonForm, createLesson, logout) –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ

        function showAddLessonForm() {
            document.getElementById('addLessonForm').style.display = 'block';
            document.getElementById('lessonMsg').textContent = '';
        }

        function hideAddLessonForm() {
            document.getElementById('addLessonForm').style.display = 'none';
            document.getElementById('lessonTitle').value = '';
            document.getElementById('lessonDesc').value = '';
            document.getElementById('lessonContent').value = '';
            document.getElementById('lessonOrder').value = '1';
        }

        async function createLesson() {
            const title = document.getElementById('lessonTitle').value.trim();
            const description = document.getElementById('lessonDesc').value.trim();
            const content = document.getElementById('lessonContent').value.trim();
            const order = parseInt(document.getElementById('lessonOrder').value) || 1;

            const msg = document.getElementById('lessonMsg');

            if (!title || !content) {
                msg.textContent = '–ê—Ç–∞—É –º–µ–Ω –º–∞–∑–º“±–Ω –º—ñ–Ω–¥–µ—Ç—Ç—ñ!';
                msg.style.color = 'red';
                return;
            }

            try {
                const res = await fetch(API + '/api/lessons', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({title, description, content, order})
                });

                if (res.ok) {
                    msg.textContent = '–°–∞–±–∞“õ —Å”ô—Ç—Ç—ñ “õ–æ—Å—ã–ª–¥—ã! üéâ';
                    msg.style.color = 'green';
                    hideAddLessonForm();
                    loadMyLessons();
                } else {
                    const error = await res.text();
                    msg.textContent = '“ö–∞—Ç–µ: ' + error;
                    msg.style.color = 'red';
                }
            } catch (err) {
                msg.textContent = '–°–µ—Ä–≤–µ—Ä “õ–∞—Ç–µ—Å—ñ';
                msg.style.color = 'red';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        loadMyLessons();
    </script>
</body>
</html>